From 6777590d284fee1fcac8bd47aacbd20229be9136 Mon Sep 17 00:00:00 2001
From: TheScarastic <warabhishek@gmail.com>
Date: Thu, 5 Oct 2023 23:46:07 +0200
Subject: [PATCH 1/2] sepolicy: Allow netutils to use dac_override

Change-Id: Idfe2749c191f6f454d93e3d7b6a8eaa3681564e4
---
 prebuilts/api/34.0/private/domain.te           | 1 +
 prebuilts/api/34.0/private/netutils_wrapper.te | 5 ++++-
 private/domain.te                              | 1 +
 private/netutils_wrapper.te                    | 5 ++++-
 4 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/prebuilts/api/34.0/private/domain.te b/prebuilts/api/34.0/private/domain.te
index f98a285cb..9115fc869 100644
--- a/prebuilts/api/34.0/private/domain.te
+++ b/prebuilts/api/34.0/private/domain.te
@@ -455,6 +455,7 @@ define(`dac_override_allowed', `{
   lmkd
   migrate_legacy_obb_data
   netd
+  netutils_wrapper
   postinstall_dexopt
   recovery
   rss_hwm_reset
diff --git a/prebuilts/api/34.0/private/netutils_wrapper.te b/prebuilts/api/34.0/private/netutils_wrapper.te
index 01f191561..71731eb73 100644
--- a/prebuilts/api/34.0/private/netutils_wrapper.te
+++ b/prebuilts/api/34.0/private/netutils_wrapper.te
@@ -30,6 +30,9 @@ allow netutils_wrapper { fs_bpf fs_bpf_netd_shared }:file { getattr read };
 allow netutils_wrapper { fs_bpf                    }:file write;
 allow netutils_wrapper bpfloader:bpf prog_run;
 
+# For q vendor haxx
+allow netutils_wrapper self:capability dac_override;
+
 # For /data/misc/net access to ndc and ip
 r_dir_file(netutils_wrapper, net_data_file)
 
@@ -44,4 +47,4 @@ dontaudit netutils_wrapper self:global_capability_class_set sys_resource;
 dontaudit netutils_wrapper sysfs_type:file read;
 
 # netutils wrapper may only use the following capabilities.
-neverallow netutils_wrapper self:global_capability_class_set ~{ net_admin net_raw };
+neverallow netutils_wrapper self:global_capability_class_set ~{ net_admin net_raw dac_override };
diff --git a/private/domain.te b/private/domain.te
index f98a285cb..9115fc869 100644
--- a/private/domain.te
+++ b/private/domain.te
@@ -455,6 +455,7 @@ define(`dac_override_allowed', `{
   lmkd
   migrate_legacy_obb_data
   netd
+  netutils_wrapper
   postinstall_dexopt
   recovery
   rss_hwm_reset
diff --git a/private/netutils_wrapper.te b/private/netutils_wrapper.te
index 01f191561..71731eb73 100644
--- a/private/netutils_wrapper.te
+++ b/private/netutils_wrapper.te
@@ -30,6 +30,9 @@ allow netutils_wrapper { fs_bpf fs_bpf_netd_shared }:file { getattr read };
 allow netutils_wrapper { fs_bpf                    }:file write;
 allow netutils_wrapper bpfloader:bpf prog_run;
 
+# For q vendor haxx
+allow netutils_wrapper self:capability dac_override;
+
 # For /data/misc/net access to ndc and ip
 r_dir_file(netutils_wrapper, net_data_file)
 
@@ -44,4 +47,4 @@ dontaudit netutils_wrapper self:global_capability_class_set sys_resource;
 dontaudit netutils_wrapper sysfs_type:file read;
 
 # netutils wrapper may only use the following capabilities.
-neverallow netutils_wrapper self:global_capability_class_set ~{ net_admin net_raw };
+neverallow netutils_wrapper self:global_capability_class_set ~{ net_admin net_raw dac_override };
-- 
2.34.1

