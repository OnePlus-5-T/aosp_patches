From 4457b6b411558c02c8e0de7c39e942f36c7fed78 Mon Sep 17 00:00:00 2001
From: Roberto Sartori <roberto.sartori.android@gmail.com>
Date: Thu, 5 Oct 2023 23:46:40 +0200
Subject: [PATCH 2/2] netutils_wrapper/network_stack: allow netutils_wrapper to
 write fs_bpf_netd_shared

Needed (at least) with OnePlus blobs from 4.4.

Change-Id: I6131748bb674e6cc4af983ac73ce03289ba878cb
Signed-off-by: Roberto Sartori <roberto.sartori.android@gmail.com>
---
 prebuilts/api/34.0/private/network_stack.te | 4 +++-
 private/network_stack.te                    | 4 +++-
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/prebuilts/api/34.0/private/network_stack.te b/prebuilts/api/34.0/private/network_stack.te
index 84c8d4db6..fe93313aa 100644
--- a/prebuilts/api/34.0/private/network_stack.te
+++ b/prebuilts/api/34.0/private/network_stack.te
@@ -73,6 +73,9 @@ allow network_stack self:netlink_xfrm_socket { create_socket_perms_no_ioctl nlms
 allow network_stack tun_device:chr_file rw_file_perms;
 allowxperm network_stack tun_device:chr_file ioctl { TUNGETIFF TUNSETIFF TUNSETLINK TUNSETCARRIER };
 
+# Used with old vendor blobs from OnePlus
+allow netutils_wrapper fs_bpf_netd_shared:file write;
+
 ############### NEVER ALLOW RULES
 # This place is as good as any for these rules,
 # and it is probably the most appropriate because
@@ -96,7 +99,6 @@ neverallow netd fs_bpf_netd_readonly:file write;
 # netutils_wrapper requires access to be able to run iptables and only needs readonly access
 neverallow { domain -bpfloader -netd -netutils_wrapper -network_stack -system_server } fs_bpf_netd_shared:dir ~getattr;
 neverallow { domain -bpfloader -netd -netutils_wrapper -network_stack -system_server } fs_bpf_netd_shared:file *;
-neverallow netutils_wrapper fs_bpf_netd_shared:file write;
 
 # S+: Only the bpfloader and the network_stack should ever touch 'fs_bpf_tethering' programs/maps.
 neverallow { domain -bpfloader -network_stack } fs_bpf_tethering:dir ~getattr;
diff --git a/private/network_stack.te b/private/network_stack.te
index 84c8d4db6..fe93313aa 100644
--- a/private/network_stack.te
+++ b/private/network_stack.te
@@ -73,6 +73,9 @@ allow network_stack self:netlink_xfrm_socket { create_socket_perms_no_ioctl nlms
 allow network_stack tun_device:chr_file rw_file_perms;
 allowxperm network_stack tun_device:chr_file ioctl { TUNGETIFF TUNSETIFF TUNSETLINK TUNSETCARRIER };
 
+# Used with old vendor blobs from OnePlus
+allow netutils_wrapper fs_bpf_netd_shared:file write;
+
 ############### NEVER ALLOW RULES
 # This place is as good as any for these rules,
 # and it is probably the most appropriate because
@@ -96,7 +99,6 @@ neverallow netd fs_bpf_netd_readonly:file write;
 # netutils_wrapper requires access to be able to run iptables and only needs readonly access
 neverallow { domain -bpfloader -netd -netutils_wrapper -network_stack -system_server } fs_bpf_netd_shared:dir ~getattr;
 neverallow { domain -bpfloader -netd -netutils_wrapper -network_stack -system_server } fs_bpf_netd_shared:file *;
-neverallow netutils_wrapper fs_bpf_netd_shared:file write;
 
 # S+: Only the bpfloader and the network_stack should ever touch 'fs_bpf_tethering' programs/maps.
 neverallow { domain -bpfloader -network_stack } fs_bpf_tethering:dir ~getattr;
-- 
2.34.1

